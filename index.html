<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CineTrack PRO - Universal Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { 
            --bg-deep: #020617; --bg-card: #1e293b; --accent: #38bdf8; 
            --star: #fbbf24; --text-main: #ffffff; --text-dim: #cbd5e1; --tmdb-green: #4ade80;
            --youtube: #ff0000; --progress-bg: #334155;
        }

        body { background-color: var(--bg-deep); color: var(--text-main); font-family: 'Inter', sans-serif; padding-bottom: 80px; overflow-x: hidden; }

        /* Layout Responsivo para a Lista */
        #myList { 
            display: grid; 
            gap: 15px; 
            padding: 10px;
            grid-template-columns: repeat(2, 1fr); /* Telem√≥vel: 2 colunas */
        }
        @media (min-width: 768px) { #myList { grid-template-columns: repeat(3, 1fr); } } /* Tablet: 3 */
        @media (min-width: 1024px) { #myList { grid-template-columns: repeat(5, 1fr); } } /* PC: 5 ou 6 */

        .stats-bar { background: rgba(56, 189, 248, 0.05); border: 1px solid rgba(56, 189, 248, 0.1); border-radius: 15px; padding: 15px; margin-bottom: 25px; display: flex; justify-content: space-around; }
        .stat-val { display: block; font-size: 1.1rem; font-weight: 800; color: var(--accent); text-align: center;}
        .stat-label { font-size: 0.6rem; text-transform: uppercase; color: var(--text-dim); }

        .search-container { display: flex; gap: 8px; width: 100%; max-width: 650px; margin: 0 auto 15px; }
        .form-control-lg { background: #0f172a !important; border: 2px solid #334155 !important; color: white !important; border-radius: 12px; font-size: 1rem; }
        
        #suggestions { position: absolute; width: calc(100% - 20px); left: 10px; background: #1e293b; border-radius: 12px; display: none; z-index: 2000; max-height: 250px; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        /* Cards em estilo vertical para Mobile */
        .m-card { background: var(--bg-card); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); position: relative; overflow: hidden; display: flex; flex-direction: column; transition: 0.2s; }
        .m-card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .m-card-body { padding: 10px; }
        .card-title { font-size: 0.85rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .card-progress-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: var(--progress-bg); }
        .card-progress-fill { height: 100%; background: var(--accent); }

        .btn-del-mini { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }

        /* Barras de Filtros (Scroll horizontal em mobile) */
        .folder-row, .genre-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .folder-row::-webkit-scrollbar { display: none; }

        .folder-group { display: flex; align-items: center; background: #1e293b; border-radius: 8px; border: 1px solid #334155; white-space: nowrap; }
        .btn-genre { background: transparent; color: var(--text-dim); border: 1px solid #334155; border-radius: 20px; padding: 4px 15px; font-size: 0.75rem; white-space: nowrap; }
        .btn-genre.active { background: rgba(56, 189, 248, 0.2); border-color: var(--accent); color: var(--accent); }

        /* Ajustes Modal Mobile */
        .modal-body { padding: 15px 20px 25px; margin-top: -60px; position: relative; }
        .backdrop-img { width: 100%; height: 220px; object-fit: cover; mask-image: linear-gradient(to bottom, black 40%, transparent 100%); }
        .poster-main { width: 100px; border-radius: 12px; border: 3px solid #0f172a; margin-top: -40px; }
        
        .streaming-icon { width: 30px; height: 30px; border-radius: 6px; margin-right: 5px; }

        /* Pain√©is Laterais Responsivos */
        .side-pane { background: rgba(15, 23, 42, 0.98); border-left: 1px solid #334155; height: 100vh; position: fixed; right: -100%; top: 0; width: 100%; max-width: 350px; z-index: 4000; transition: 0.4s; padding: 25px; backdrop-filter: blur(15px); }
        .side-pane.open { right: 0; }

        .btn-plus-ep { background: var(--accent); color: #020617; border: none; border-radius: 8px; font-weight: 800; padding: 5px 15px; }

        #undoBanner { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; display:none; background: var(--accent); color: #020617; padding: 15px; border-radius: 15px; font-weight: 800; text-align: center; z-index: 5000; }
    </style>
</head>
<body>

<div id="undoBanner">REMOVIDO <button class="btn btn-sm btn-dark ms-2 fw-bold" onclick="undo()">DESFAZER</button></div>

<div class="side-pane shadow-lg" id="histPane">
    <div class="d-flex justify-content-between align-items-center mb-4"><h5>Atividade</h5><button class="btn-close btn-close-white" onclick="togglePane('histPane')"></button></div>
    <div id="histContent"></div>
</div>

<div class="side-pane shadow-lg" id="calPane">
    <div class="d-flex justify-content-between align-items-center mb-4"><h5>üìÖ Estreias</h5><button class="btn-close btn-close-white" onclick="togglePane('calPane')"></button></div>
    <div id="calContent"></div>
</div>

<div class="container-fluid px-3 py-4">
    <header class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold m-0"><span style="color:var(--accent)">Cine</span>Track</h3>
        <div class="d-flex gap-1">
            <button class="btn btn-sm btn-warning" onclick="updateCalendar()">üìÖ</button>
            <button class="btn btn-sm btn-outline-info" onclick="togglePane('histPane')">üïí</button>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">‚öôÔ∏è</button>
                <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
                    <li><button class="dropdown-item" onclick="exportJSON()">Exportar</button></li>
                    <li><label class="dropdown-item" for="importFile">Importar</label></li>
                </ul>
                <input type="file" id="importFile" style="display:none" onchange="importJSON(this)">
            </div>
        </div>
    </header>

    <div class="stats-bar" id="statsArea"></div>

    <div class="search-container position-relative">
        <input type="text" id="term" class="form-control form-control-lg" placeholder="Adicionar Filme ou S√©rie..." onkeyup="search()">
        <button class="btn-random" onclick="pickRandom()">üé≤</button>
        <div id="suggestions"></div>
    </div>

    <div class="folder-row mb-2" id="folderBar"></div>
    <div class="genre-row mb-3" id="genreBar"></div>

    <div class="d-flex justify-content-center gap-2 mb-4">
        <button class="btn-tool active" id="btn-all" onclick="setFilter('all')">Tudo</button>
        <button class="btn-tool" id="btn-movie" onclick="setFilter('movie')">Filmes</button>
        <button class="btn-tool" id="btn-tv" onclick="setFilter('tv')">S√©ries</button>
    </div>

    <div id="myList"></div>
</div>

<div class="modal fade" id="win" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-fullscreen-sm-down">
        <div class="modal-content" id="winContent"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const KEY = '8661bff51991b4bcd2a9a9e9fa66b639';
    let db = JSON.parse(localStorage.getItem('cine_vMulti')) || [];
    let folders = JSON.parse(localStorage.getItem('folders_vMulti')) || ["Favoritos"];
    let historyStack = [];
    let currentFilter = 'all';
    let currentFolderFilter = 'all';
    let currentGenreFilter = 'all';

    function save() { 
        localStorage.setItem('cine_vMulti', JSON.stringify(db)); 
        localStorage.setItem('folders_vMulti', JSON.stringify(folders));
        render(); renderStats(); renderFolderBar(); renderGenreBar();
    }

    async function search() {
        const q = document.getElementById('term').value;
        const box = document.getElementById('suggestions');
        if(q.length < 2) { box.style.display = 'none'; return; }
        const r = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${KEY}&query=${q}&language=pt-PT`);
        const d = await r.json();
        box.innerHTML = d.results.filter(i => i.media_type !== 'person').slice(0,6).map(i => `
            <div class="p-3 border-bottom d-flex align-items-center" style="cursor:pointer" onclick="add(${i.id}, '${i.media_type}')">
                <img src="https://image.tmdb.org/t/p/w92${i.poster_path}" style="width:35px; border-radius:4px; margin-right:15px">
                <div class="flex-grow-1"><div class="fw-bold text-white small">${i.title || i.name}</div></div>
            </div>`).join('');
        box.style.display = 'block';
    }

    async function add(id, type) {
        document.getElementById('suggestions').style.display = 'none';
        document.getElementById('term').value = '';
        if(db.find(x => x.id === id)) return;
        const r = await fetch(`https://api.themoviedb.org/3/${type}/${id}?api_key=${KEY}&append_to_response=watch/providers,recommendations&language=pt-PT`);
        const i = await r.json();
        db.unshift({
            id: i.id, type: type, title: i.title || i.name,
            img: `https://image.tmdb.org/t/p/w500${i.poster_path}`,
            bg: `https://image.tmdb.org/t/p/original${i.backdrop_path}`,
            desc: i.overview || "Sem sinopse.",
            score: i.vote_average ? i.vote_average.toFixed(1) : '?',
            genres: i.genres?.map(g => g.name) || [],
            status: 'Para Ver', nota: 0, folder: 'Nenhuma',
            ep_atual: 0, ep_total: i.number_of_episodes || 0,
            streaming: i['watch/providers']?.results?.PT?.flatrate || [],
            next_date: i.next_episode_to_air?.air_date || i.release_date || ''
        });
        save();
    }

    function render() {
        const container = document.getElementById('myList');
        let list = db;
        if(currentFilter !== 'all') list = list.filter(i => i.type === currentFilter);
        if(currentFolderFilter !== 'all') list = list.filter(i => i.folder === currentFolderFilter);
        if(currentGenreFilter !== 'all') list = list.filter(i => i.genres.includes(currentGenreFilter));
        
        container.innerHTML = list.map(i => `
            <div class="m-card shadow" onclick="openModal(${i.id})">
                <img src="${i.img}">
                <button class="btn-del-mini" onclick="event.stopPropagation(); remove(${i.id})">‚úï</button>
                <div class="m-card-body">
                    <div class="card-title">${i.title}</div>
                    <div class="d-flex justify-content-between align-items-center mt-1">
                        <span style="color:var(--tmdb-green); font-size:0.75rem; font-weight:800">‚≠ê ${i.score}</span>
                        ${i.type === 'tv' ? `<span class="small text-dim" style="font-size:0.6rem">${i.ep_atual}/${i.ep_total}</span>` : ''}
                    </div>
                </div>
                ${i.type === 'tv' ? `<div class="card-progress-container"><div class="card-progress-fill" style="width: ${(i.ep_atual/i.ep_total)*100}%"></div></div>` : ''}
            </div>`).join('');
    }

    function openModal(id) {
        const i = db.find(x => x.id === id);
        const win = document.getElementById('winContent');
        win.innerHTML = `
            <div class="position-relative">
                <img src="${i.bg}" class="backdrop-img">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex gap-3 align-items-start mb-3">
                    <img src="${i.img}" class="poster-main shadow">
                    <div class="flex-grow-1 pt-4">
                        <h5 class="fw-bold mb-1">${i.title}</h5>
                        <div class="d-flex flex-wrap gap-1 mb-2">
                            ${i.streaming.map(s => `<img src="https://image.tmdb.org/t/p/w92${s.logo_path}" class="streaming-icon">`).join('')}
                        </div>
                    </div>
                </div>

                ${i.type === 'tv' ? `
                <div class="bg-dark p-3 rounded-4 mb-3 border border-secondary">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small fw-bold">Epis√≥dios: ${i.ep_atual}/${i.ep_total}</span>
                        <button class="btn-plus-ep" onclick="updateEp(${i.id}, 1)">+1 Ep</button>
                    </div>
                    <input type="range" class="form-range" min="0" max="${i.ep_total}" value="${i.ep_atual}" onchange="updateEp(${i.id}, this.value, true)">
                </div>` : ''}

                <div class="d-flex gap-2 mb-3">
                    <button class="btn btn-sm btn-danger w-100 fw-bold" onclick="loadTrailer(${i.id}, '${i.type}')">Assistir Trailer</button>
                </div>
                <div id="trailerContainer" class="video-container mb-3"></div>
                <p class="small text-dim" style="line-height:1.4">${i.desc}</p>
                
                <div class="row g-2 mt-2">
                    <div class="col-6">
                        <select class="form-select form-select-sm bg-dark text-white border-secondary" onchange="update(${i.id}, 'status', this.value)">
                            <option ${i.status === 'Para Ver' ? 'selected' : ''}>Para Ver</option><option ${i.status === 'Visto' ? 'selected' : ''}>Visto</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <select class="form-select form-select-sm bg-dark text-white border-secondary" onchange="update(${i.id}, 'folder', this.value)">
                            <option value="Nenhuma">Pasta: Nenhuma</option>
                            ${folders.map(f => `<option value="${f}" ${i.folder === f ? 'selected' : ''}>${f}</option>`).join('')}
                        </select>
                    </div>
                </div>
            </div>`;
        new bootstrap.Modal(document.getElementById('win')).show();
    }

    async function loadTrailer(id, type) {
        let r = await fetch(`https://api.themoviedb.org/3/${type}/${id}/videos?api_key=${KEY}`);
        let d = await r.json();
        const t = d.results.find(v => v.site === 'YouTube');
        if(t) {
            document.getElementById('trailerContainer').innerHTML = `<iframe src="https://www.youtube.com/embed/${t.key}" frameborder="0" allowfullscreen style="width:100%; height:200px; border-radius:12px"></iframe>`;
            document.getElementById('trailerContainer').style.display = 'block';
        }
    }

    function updateEp(id, val, isDirect = false) {
        const i = db.find(x => x.id === id);
        i.ep_atual = isDirect ? parseInt(val) : Math.min(i.ep_total, i.ep_atual + 1);
        if(i.ep_atual === i.ep_total) i.status = 'Visto';
        save(); openModal(id);
    }

    function renderFolderBar() {
        const bar = document.getElementById('folderBar');
        bar.innerHTML = `<div class="folder-group ${currentFolderFilter === 'all' ? 'active' : ''}"><button class="btn-folder-name" onclick="setFolderFilter('all')">Tudo</button></div>` + 
            folders.map(f => `<div class="folder-group ${currentFolderFilter === f ? 'active' : ''}"><button class="btn-folder-name" onclick="setFolderFilter('${f}')">${f}</button><button class="btn-folder-del" onclick="deleteFolder('${f}')">‚úï</button></div>`).join('') +
            `<button class="btn btn-sm btn-outline-secondary" onclick="newFolder()">+ Pasta</button>`;
    }

    function renderGenreBar() {
        const bar = document.getElementById('genreBar');
        const all = [...new Set(db.flatMap(i => i.genres))].sort();
        bar.innerHTML = `<button class="btn-genre ${currentGenreFilter === 'all' ? 'active' : ''}" onclick="setGenreFilter('all')">Todos</button>` + 
            all.map(g => `<button class="btn-genre ${currentGenreFilter === g ? 'active' : ''}" onclick="setGenreFilter('${g}')">${g}</button>`).join('');
    }

    function togglePane(id) { document.getElementById(id).classList.toggle('open'); }
    function newFolder() { const n = prompt("Nome da pasta:"); if(n) { folders.push(n); save(); } }
    function deleteFolder(n) { if(confirm("Apagar pasta?")) { db.forEach(i => { if(i.folder === n) i.folder = 'Nenhuma'; }); folders = folders.filter(f => f !== n); save(); } }
    function setFolderFilter(f) { currentFolderFilter = f; render(); renderFolderBar(); }
    function setGenreFilter(g) { currentGenreFilter = g; render(); renderGenreBar(); }
    function setFilter(f) { currentFilter = f; document.querySelectorAll('.btn-tool').forEach(b => b.classList.remove('active')); document.getElementById('btn-'+f).classList.add('active'); render(); }
    function update(id, k, v) { db.find(x => x.id === id)[k] = v; save(); }
    function remove(id) { const idx = db.findIndex(x => x.id === id); historyStack.push(db[idx]); db.splice(idx, 1); save(); document.getElementById('undoBanner').style.display = 'block'; setTimeout(() => document.getElementById('undoBanner').style.display = 'none', 5000); }
    function undo() { if(historyStack.length) { db.unshift(historyStack.pop()); save(); } document.getElementById('undoBanner').style.display = 'none'; }
    function renderStats() {
        const vistos = db.filter(i => i.status === 'Visto').length;
        document.getElementById('statsArea').innerHTML = `<div><span class="stat-val">${db.length}</span><span class="stat-label">Lista</span></div><div><span class="stat-val">${vistos}</span><span class="stat-label">Vistos</span></div>`;
    }
    function updateCalendar() {
        const content = document.getElementById('calContent');
        const today = new Date().toISOString().split('T')[0];
        const future = db.filter(i => i.next_date && i.next_date >= today).sort((a,b) => a.next_date.localeCompare(b.next_date));
        content.innerHTML = future.map(i => `<div class="p-3 bg-dark rounded-3 mb-2 border-start border-info border-4"><div class="fw-bold">${i.title}</div><div class="small text-accent">${i.next_date}</div></div>`).join('');
        togglePane('calPane');
    }
    function pickRandom() { if(db.length) openModal(db[Math.floor(Math.random()*db.length)].id); }
    function exportJSON() { const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db)); const a = document.createElement('a'); a.href = data; a.download = "cinetrack.json"; a.click(); }
    function importJSON(input) { const reader = new FileReader(); reader.onload = (e) => { db = JSON.parse(e.target.result); save(); }; reader.readAsText(input.files[0]); }

    window.onload = () => { render(); renderStats(); renderFolderBar(); renderGenreBar(); };
</script>
</body>
</html>
