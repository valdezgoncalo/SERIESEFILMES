<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineTrack Pro - Ultra Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { 
            --bg-deep: #020617; 
            --bg-card: #1e293b; 
            --accent: #38bdf8; 
            --star: #fbbf24;
            --text-main: #ffffff;
            --text-dim: #cbd5e1;
            --tmdb-green: #4ade80;
        }

        body { 
            background-color: var(--bg-deep); 
            color: var(--text-main); 
            font-family: 'Inter', sans-serif;
            padding-bottom: 50px;
        }

        /* PESQUISA E FILTROS */
        .search-box { position: relative; max-width: 650px; margin: 0 auto 25px; }
        .form-control-lg { 
            background: #0f172a !important; 
            border: 2px solid #334155 !important;
            color: white !important;
            border-radius: 15px;
        }
        #suggestions { 
            position: absolute; width: 100%; background: #1e293b; 
            border: 1px solid var(--accent); border-radius: 10px; 
            display: none; z-index: 2000; margin-top: 5px; 
        }

        .btn-filter { background: #1e293b; color: white; border: 1px solid #334155; border-radius: 12px; padding: 8px 24px; transition: 0.3s; }
        .btn-filter.active { background: var(--accent); color: #020617; font-weight: bold; }

        /* LISTA PRINCIPAL */
        .m-card { 
            background: var(--bg-card); border-radius: 16px; padding: 16px; 
            margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.1);
            transition: 0.2s ease; cursor: pointer;
        }
        .m-card:hover { border-color: var(--accent); transform: scale(1.01); }
        .card-title { font-size: 1.15rem; font-weight: 700; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* MODAL E SAGA */
        .modal-content { background: #0f172a; border-radius: 24px; color: var(--text-main); border: 1px solid #334155; overflow: hidden; }
        .backdrop-img { width: 100%; height: 350px; object-fit: cover; mask-image: linear-gradient(to bottom, black 50%, transparent 100%); }
        .modal-body { padding: 0 30px 30px; margin-top: -100px; }
        .poster-main { width: 150px; border-radius: 18px; border: 4px solid #0f172a; box-shadow: 0 20px 40px rgba(0,0,0,0.6); }

        .saga-list { display: flex; gap: 15px; overflow-x: auto; padding: 10px 0; scrollbar-width: thin; }
        .saga-item { flex: 0 0 110px; text-align: center; cursor: pointer; transition: 0.3s; }
        .saga-item:hover { transform: scale(1.1); }
        .saga-img { width: 100px; height: 150px; border-radius: 10px; object-fit: cover; border: 2px solid transparent; }
        .saga-item:hover .saga-img { border-color: var(--accent); }

        .type-badge { background: rgba(56, 189, 248, 0.2); color: var(--accent); padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
        
        #undoBanner { 
            display: none; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
            background: var(--accent); color: #020617; padding: 15px 30px; border-radius: 15px;
            font-weight: 800; z-index: 3000; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

<div id="undoBanner">REMOVIDO <button class="btn btn-sm btn-dark ms-3 rounded-pill fw-bold" onclick="undo()">DESFAZER</button></div>

<div class="container py-4">
    <header class="d-flex justify-content-between align-items-center mb-5">
        <h2 class="fw-bold m-0"><span style="color:var(--accent)">Cine</span>Track PRO</h2>
        <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="exportJSON()">Backup</button>
    </header>

    <div class="search-box">
        <input type="text" id="term" class="form-control form-control-lg" placeholder="Pesquisar filmes ou séries no TMDB..." onkeyup="search()">
        <div id="suggestions"></div>
    </div>

    <div class="d-flex justify-content-center gap-2 mb-4">
        <button class="btn-filter active" id="btn-all" onclick="setFilter('all')">Tudo</button>
        <button class="btn-filter" id="btn-movie" onclick="setFilter('movie')">Filmes</button>
        <button class="btn-filter" id="btn-tv" onclick="setFilter('tv')">Séries</button>
    </div>

    <div id="myList" class="row justify-content-center"></div>
</div>

<div class="modal fade" id="win" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" id="winContent"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const KEY = '8661bff51991b4bcd2a9a9e9fa66b639';
    let db = JSON.parse(localStorage.getItem('cine_v8_ultra')) || [];
    let historyStack = [];
    let currentFilter = 'all';

    function save() { localStorage.setItem('cine_v8_ultra', JSON.stringify(db)); render(); }

    async function search() {
        const q = document.getElementById('term').value;
        const box = document.getElementById('suggestions');
        if(q.length < 2) { box.style.display = 'none'; return; }

        const r = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${KEY}&query=${q}&language=pt-PT`);
        const d = await r.json();
        
        box.innerHTML = d.results.filter(i => i.media_type !== 'person').slice(0,6).map(i => `
            <div class="p-3 border-bottom d-flex align-items-center" style="cursor:pointer" onclick="add(${i.id}, '${i.media_type}')">
                <img src="https://image.tmdb.org/t/p/w92${i.poster_path}" style="width:35px; border-radius:4px; margin-right:15px">
                <div class="flex-grow-1">
                    <div class="fw-bold text-white">${i.title || i.name}</div>
                    <div class="small text-info text-uppercase" style="font-size:0.7rem">${i.media_type} • ${(i.release_date || i.first_air_date || '').split('-')[0]}</div>
                </div>
            </div>`).join('');
        box.style.display = 'block';
    }

    async function add(id, type) {
        document.getElementById('suggestions').style.display = 'none';
        document.getElementById('term').value = '';
        if(db.find(x => x.id === id)) return;

        const r = await fetch(`https://api.themoviedb.org/3/${type}/${id}?api_key=${KEY}&append_to_response=recommendations&language=pt-PT`);
        const i = await r.json();

        let related = [];
        let relatedTitle = "Recomendações";

        if(i.belongs_to_collection) {
            const collRes = await fetch(`https://api.themoviedb.org/3/collection/${i.belongs_to_collection.id}?api_key=${KEY}&language=pt-PT`);
            const collData = await collRes.json();
            related = collData.parts.filter(p => p.id !== i.id).map(p => ({id: p.id, title: p.title, img: p.poster_path, type: 'movie'}));
            relatedTitle = `Saga: ${i.belongs_to_collection.name}`;
        } else {
            related = i.recommendations?.results?.slice(0, 8).map(p => ({id: p.id, title: p.title || p.name, img: p.poster_path, type: type})) || [];
        }

        db.unshift({
            id: i.id, type: type, title: i.title || i.name,
            img: i.poster_path ? `https://image.tmdb.org/t/p/w500${i.poster_path}` : 'https://via.placeholder.com/500x750',
            bg: i.backdrop_path ? `https://image.tmdb.org/t/p/original${i.backdrop_path}` : '',
            desc: i.overview || "Sem sinopse.",
            score: i.vote_average ? i.vote_average.toFixed(1) : '?',
            genres: i.genres?.map(g => g.name).join(' / ') || 'N/A',
            date: (i.release_date || i.first_air_date || 'N/A'),
            runtime: i.runtime || (i.episode_run_time ? i.episode_run_time[0] : '?'),
            status: 'Para Ver', nota: 0,
            related: related, relatedTitle: relatedTitle
        });
        save();
    }

    function render() {
        const div = document.getElementById('myList');
        const filtered = currentFilter === 'all' ? db : db.filter(i => i.type === currentFilter);

        div.innerHTML = filtered.map(i => `
            <div class="col-12 col-md-10">
                <div class="m-card d-flex align-items-center" onclick="openModal(${i.id})">
                    <img src="${i.img}" style="width:60px; height:85px; object-fit:cover; border-radius:10px; margin-right:20px">
                    <div class="flex-grow-1 overflow-hidden">
                        <div class="card-title">${i.title}</div>
                        <div class="d-flex align-items-center gap-2 mt-1">
                            <span class="type-badge">${i.type === 'tv' ? 'Série' : 'Filme'}</span>
                            <span style="color:var(--tmdb-green); font-weight:bold; font-size:0.9rem">⭐ ${i.score}</span>
                            <span style="color:var(--accent); font-size:0.85rem; font-weight:600">• ${i.date.split('-')[0]}</span>
                        </div>
                    </div>
                    <button class="btn text-danger opacity-50" onclick="event.stopPropagation(); remove(${i.id})">✕</button>
                </div>
            </div>`).join('');
    }

    function openModal(id) {
        const i = db.find(x => x.id === id);
        const win = document.getElementById('winContent');
        win.innerHTML = `
            <div class="position-relative">
                <img src="${i.bg}" class="backdrop-img">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-4" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex gap-4 align-items-end mb-4">
                    <img src="${i.img}" class="poster-main">
                    <div class="flex-grow-1">
                        <h2 class="fw-bold text-white mb-2">${i.title}</h2>
                        <div class="d-flex gap-2 flex-wrap">
                            <span class="type-badge">${i.type}</span>
                            <span class="badge bg-dark text-warning">⭐ TMDB ${i.score}</span>
                            <span class="badge bg-secondary">${i.runtime} MIN</span>
                        </div>
                    </div>
                </div>
                <div class="mb-3"><small class="text-info fw-bold text-uppercase">${i.genres}</small></div>
                <p style="color:#e2e8f0; line-height:1.7; font-size:0.95rem">${i.desc}</p>

                ${i.related.length > 0 ? `
                    <h6 class="fw-bold text-muted small text-uppercase mt-4 mb-3">${i.relatedTitle}</h6>
                    <div class="saga-list mb-4">
                        ${i.related.map(r => `
                            <div class="saga-item" onclick="add(${r.id}, '${r.type}')" data-bs-dismiss="modal">
                                <img src="https://image.tmdb.org/t/p/w185${r.img}" class="saga-img shadow-lg">
                                <div style="font-size:0.65rem; color:var(--text-dim); margin-top:8px" class="text-truncate">${r.title}</div>
                            </div>`).join('')}
                    </div>` : ''}

                <div class="row g-2 mt-2 bg-dark p-3 rounded-4">
                    <div class="col-6">
                        <label class="small text-muted d-block mb-1 fw-bold text-uppercase">Meu Estado</label>
                        <select class="form-select bg-dark text-white border-0 fw-bold" onchange="update(${i.id}, 'status', this.value)">
                            <option ${i.status === 'Para Ver' ? 'selected' : ''}>Para Ver</option>
                            <option ${i.status === 'Visto' ? 'selected' : ''}>Visto</option>
                        </select>
                    </div>
                    <div class="col-6 text-center border-start border-secondary">
                        <label class="small text-muted d-block mb-1 fw-bold text-uppercase">Minha Nota</label>
                        <select class="form-select bg-dark text-warning border-0 text-center fw-bold" onchange="update(${i.id}, 'nota', this.value)">
                            ${[0,1,2,3,4,5].map(n => `<option value="${n}" ${i.nota == n ? 'selected' : ''}>${n} Estrelas</option>`).join('')}
                        </select>
                    </div>
                </div>
            </div>`;
        new bootstrap.Modal(document.getElementById('win')).show();
    }

    function setFilter(f) {
        currentFilter = f;
        document.querySelectorAll('.btn-filter').forEach(btn => btn.classList.remove('active'));
        document.getElementById('btn-' + f).classList.add('active');
        render();
    }

    function remove(id) {
        const idx = db.findIndex(x => x.id === id);
        historyStack.push(db[idx]);
        db.splice(idx, 1);
        save();
        document.getElementById('undoBanner').style.display = 'block';
        setTimeout(() => document.getElementById('undoBanner').style.display = 'none', 8000);
    }

    function undo() {
        if(historyStack.length) { db.unshift(historyStack.pop()); save(); }
        document.getElementById('undoBanner').style.display = 'none';
    }

    function update(id, key, val) {
        const i = db.find(x => x.id === id);
        i[key] = key === 'nota' ? parseInt(val) : val;
        save();
    }

    function exportJSON() {
        const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
        const a = document.createElement('a'); a.href = data; a.download = "cinetrack_full_backup.json"; a.click();
    }

    window.onload = render;
</script>
</body>
</html>
