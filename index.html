<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineTrack - SAGAS E FILTROS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --accent: #facc15; --bg: #0f172a; --card: #1e293b; }
        body { background-color: var(--bg); color: white; font-family: sans-serif; }
        
        /* NOVO: Estilo dos Filtros */
        .filter-bar { background: #1a202c; padding: 15px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #334155; }
        .nav-pills .nav-link { color: #94a3b8; }
        .nav-pills .nav-link.active { background-color: #38bdf8; color: white; }

        /* Cart√µes com Estrelas */
        .movie-card { background: var(--card); border-radius: 10px; border: 1px solid #334155; overflow: hidden; margin-bottom: 15px; transition: 0.3s; }
        .movie-card:hover { border-color: #38bdf8; }
        .star-rating { color: var(--accent); font-size: 1.1rem; }
        
        /* Sec√ß√£o de Sagas no Modal */
        .saga-item { width: 90px; cursor: pointer; transition: 0.2s; border-radius: 5px; }
        .saga-item:hover { transform: scale(1.1); border: 2px solid var(--accent); }
        
        #undoBanner { display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 300px; }
    </style>
</head>
<body>

<div id="undoBanner" class="alert alert-warning shadow-lg text-center">
    A√ß√£o registada! <button class="btn btn-sm btn-dark ms-2" onclick="undoLastAction()">ANULAR ERRO</button>
</div>

<div class="container py-4">
    <h2 class="text-center mb-4">üé¨ My CineList</h2>

    <div class="input-group input-group-lg mb-4 shadow">
        <input type="text" id="movieInput" class="form-control bg-dark text-white border-secondary" placeholder="Pesquisar Predator, Matrix, etc...">
        <button class="btn btn-primary" onclick="searchMedia()">ADICIONAR</button>
    </div>

    <div class="filter-bar d-flex justify-content-center">
        <ul class="nav nav-pills" id="filterGroup">
            <li class="nav-item"><button class="nav-link active" onclick="setFilter('all', this)">TUDO</button></li>
            <li class="nav-item"><button class="nav-link" onclick="setFilter('movie', this)">FILMES</button></li>
            <li class="nav-item"><button class="nav-link" onclick="setFilter('tv', this)">S√âRIES</button></li>
        </ul>
    </div>

    <div id="mainList" class="row">
        </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary" id="modalContent"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_KEY = '8661bff51991b4bcd2a9a9e9fa66b639';
    let database = [];
    let history = [];
    let currentFilter = 'all';

    async function searchMedia(title = null) {
        const query = title || document.getElementById('movieInput').value;
        if (!query) return;

        const res = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${API_KEY}&query=${encodeURIComponent(query)}&language=pt-PT`);
        const data = await res.json();
        if (data.results?.length > 0) {
            const item = data.results[0];
            const type = item.media_type === 'tv' ? 'tv' : 'movie';
            
            // Busca detalhes, recomenda√ß√µes (SAGAS)
            const detailsRes = await fetch(`https://api.themoviedb.org/3/${type}/${item.id}?api_key=${API_KEY}&append_to_response=recommendations&language=pt-PT`);
            const details = await detailsRes.json();

            const entry = {
                dbId: Date.now(),
                title: details.title || details.name,
                type: type,
                year: (details.release_date || details.first_air_date || '').split('-')[0],
                poster: `https://image.tmdb.org/t/p/w500${details.poster_path}`,
                desc: details.overview,
                myRating: 0,
                tmdbRating: details.vote_average.toFixed(1),
                related: details.recommendations?.results?.slice(0, 5) || []
            };

            database.unshift(entry);
            history.push({type: 'ADD', data: entry});
            showUndo();
            render();
            document.getElementById('movieInput').value = '';
        }
    }

    function render() {
        const list = document.getElementById('mainList');
        list.innerHTML = '';
        
        const filtered = currentFilter === 'all' ? database : database.filter(i => i.type === currentFilter);

        filtered.forEach(item => {
            list.innerHTML += `
                <div class="col-12 col-md-6 mb-3">
                    <div class="movie-card d-flex align-items-center p-2" onclick="openDetails(${item.dbId})">
                        <img src="${item.poster}" style="width:50px; border-radius:5px;" class="me-3">
                        <div class="flex-grow-1">
                            <h6 class="mb-0">${item.title} (${item.year})</h6>
                            <div class="star-rating">${'‚òÖ'.repeat(item.myRating)}${'‚òÜ'.repeat(5-item.myRating)}</div>
                        </div>
                        <button class="btn btn-sm btn-outline-danger border-0" onclick="event.stopPropagation(); remove(${item.dbId})">‚úï</button>
                    </div>
                </div>`;
        });
    }

    function openDetails(id) {
        const item = database.find(i => i.dbId === id);
        const modal = document.getElementById('modalContent');
        modal.innerHTML = `
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-md-4"><img src="${item.poster}" class="img-fluid rounded"></div>
                    <div class="col-md-8">
                        <h3>${item.title}</h3>
                        <p class="text-info small">Rating Global: ‚≠ê ${item.tmdbRating}</p>
                        
                        <label class="small text-warning">A MINHA CLASSIFICA√á√ÉO:</label>
                        <select class="form-select bg-dark text-white mb-3" onchange="updateStar(${item.dbId}, this.value)">
                            ${[0,1,2,3,4,5].map(v => `<option value="${v}" ${item.myRating == v ? 'selected' : ''}>${v} Estrelas</option>`).join('')}
                        </select>

                        <h6>SINOPSE</h6>
                        <p class="small text-muted">${item.desc || 'Sem descri√ß√£o.'}</p>
                        
                        <hr>
                        <h6>SAGAS / RELACIONADOS</h6>
                        <div class="d-flex gap-2 overflow-auto py-2">
                            ${item.related.map(r => `<img src="https://image.tmdb.org/t/p/w200${r.poster_path}" class="saga-item" onclick="searchMedia('${r.title || r.name}')" data-bs-dismiss="modal">`).join('')}
                        </div>
                    </div>
                </div>
            </div>`;
        new bootstrap.Modal(document.getElementById('detailsModal')).show();
    }

    function updateStar(id, val) {
        const item = database.find(i => i.dbId === id);
        item.myRating = parseInt(val);
        render();
    }

    function setFilter(f, btn) {
        currentFilter = f;
        document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        render();
    }

    function remove(id) {
        const idx = database.findIndex(i => i.dbId === id);
        history.push({type: 'DEL', data: database[idx]});
        database.splice(idx, 1);
        render();
        showUndo();
    }

    function undoLastAction() {
        const last = history.pop();
        if (last.type === 'ADD') database.shift();
        if (last.type === 'DEL') database.unshift(last.data);
        render();
        document.getElementById('undoBanner').style.display = 'none';
    }

    function showUndo() {
        const b = document.getElementById('undoBanner');
        b.style.display = 'block';
        setTimeout(() => b.style.display = 'none', 6000);
    }
</script>
</body>
</html>
